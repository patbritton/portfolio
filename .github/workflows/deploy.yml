name: Deploy Astro to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            cd /var/www/patrick.mp.ls/html

            # Verify we're in a git repository
            if [ ! -d .git ]; then
              echo "Error: Not a git repository"
              exit 1
            fi

            # Fetch and verify before resetting
            git fetch --all
            CURRENT_COMMIT=$(git rev-parse HEAD)
            git reset --hard origin/main
            NEW_COMMIT=$(git rev-parse HEAD)

            echo "Deploying from $CURRENT_COMMIT to $NEW_COMMIT"

            # Use npm ci for reproducible builds with lockfile verification
            if [ -f package-lock.json ]; then
              npm ci --production --ignore-scripts
            else
              echo "Warning: package-lock.json not found, using npm install"
              npm install --production --ignore-scripts
            fi

            # Run build
            npm run build

            if [ $? -ne 0 ]; then
              echo "Build failed, aborting deployment"
              git reset --hard $CURRENT_COMMIT
              exit 1
            fi

            # Restart or start PM2 process
            pm2 restart patrick-astro || pm2 start npm --name patrick-astro -- run preview -- --host 127.0.0.1 --port 4321
            pm2 save
