---
/* =============================================
   SEO.astro — Fully upgraded SEO system
   Includes:
   • Dynamic OG Images (/api/og/[slug])
   • Bluesky metadata
   • Article + Website OG
   • Full JSON-LD (BlogPosting / WebPage)
   • Breadcrumb schema
   • Person schema (Patrick Britton)
   • Organization schema (Patrick’s Data Lab)
   ============================================
*/

// Props
interface Props {
  title: string;
  description: string;
  canonicalUrl: string;
  image?: string;
  siteName: string;
  type?: "website" | "article";
  tags?: string[];
  publishedTime?: string;
  modifiedTime?: string;
  authorName?: string;
}

const {
  title,
  description,
  canonicalUrl,
  image,
  siteName,
  type = "website",
  tags = [],
  publishedTime,
  modifiedTime,
  authorName = "Patrick Britton"
} = Astro.props;

// Base site URL
const siteUrl = Astro.site?.toString() || "https://patrick.mp.ls";

// Ensure canonical is absolute
const fullCanonicalUrl = canonicalUrl.startsWith("http")
  ? canonicalUrl
  : `${siteUrl}${canonicalUrl}`;

// Break URL into segments for breadcrumb + slug extraction
const segments = fullCanonicalUrl
  .replace(siteUrl, "")
  .split("?") // Ignore query parameters
  .filter(Boolean)
  .map(s => s.replace(/^\/|\/$/g, '')); // Trim leading/trailing slashes

// Extract last segment = blog slug (for dynamic OG). Check if we are on root or home
const slug = segments.length > 0 && segments[segments.length - 1] !== 'home' ? segments[segments.length - 1] : '';

// Auto OG Image (api route)
// Only generate if a slug exists and we aren't overriding
const autoImage = slug ? `${siteUrl}/api/og/${slug}` : `${siteUrl}/images/og-image.png`;

// Final OG Image (manual override allowed)
const defaultImage = image || autoImage;

// Type (article or website)
const isArticle = type === "article";

// Dates
const pubTime = publishedTime || new Date().toISOString();
const modTime = modifiedTime || pubTime;

// Breadcrumb schema items
// Filter out the root "blog" or "projects" segment unless it's the last one
const breadcrumbs = segments.filter(seg => seg !== 'blog' && seg !== 'projects').map((seg, i) => ({
  "@type": "ListItem",
  position: i + 1,
  name: seg.replace(/-/g, " ").replace(/\b\w/g, (l) => l.toUpperCase()),
  item: `${siteUrl}/${segments.slice(0, i + 1).join("/")}/`
}));

// Bluesky card type (matching OG)
const blueskyType = isArticle ? "article" : "website";

// Global person schema
const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: authorName,
  url: siteUrl,
  sameAs: [
    "https://bsky.app/profile/patrick.mp.ls",
    "https://github.com/patbritton", // Corrected GitHub URL structure
    "https://linkedin.com/in/patrick" // Placeholder LinkedIn
  ]
};

// Global organization schema
const orgSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: "Patrick’s Data Lab",
  url: siteUrl,
  logo: {
    "@type": "ImageObject",
    url: `${siteUrl}/favicon/favicon-96x96.png`
  }
};
---

<!-- ============================================= -->
<!-- CORE SEO -->
<!-- ============================================= -->

<title>{title}</title>
<meta name="description" content={description} />
<link rel="canonical" href={fullCanonicalUrl} />

{/* Add keywords meta tag to help with keyword distribution score, though Google mostly ignores it */}
{tags.length > 0 && (
  <meta name="keywords" content={tags.join(", ")} />
)}

<!-- ============================================= -->
<!-- OPEN GRAPH (BLUESKY, LINKEDIN, FACEBOOK, DISCORD) -->
<!-- ============================================= -->

<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:url" content={fullCanonicalUrl} />
<meta property="og:type" content={type} />
<meta property="og:site_name" content={siteName} />

<meta property="og:image" content={defaultImage} />
<meta property="og:image:secure_url" content={defaultImage} />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content={title} />

<!-- Article OG tags -->
{
  isArticle && (
    <>
      <meta property="article:published_time" content={pubTime} />
      <meta property="article:modified_time" content={modTime} />
      {tags.map(tag => <meta property="article:tag" content={tag} />)}
    </>
  )
}

<!-- ============================================= -->
<!-- BLUESKY META -->
<!-- Note: Bluesky relies heavily on Open Graph, but these tags can ensure compatibility -->
<!-- ============================================= -->
<meta property="bsky:title" content={title} />
<meta property="bsky:description" content={description} />
<meta property="bsky:type" content={blueskyType} />
<meta property="bsky:url" content={fullCanonicalUrl} />
<meta property="bsky:image" content={defaultImage} />

<!-- ============================================= -->
<!-- JSON-LD: MAIN SCHEMA (BlogPosting/WebPage) -->
<!-- ============================================= -->

<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": isArticle ? "BlogPosting" : "WebPage",
  headline: title,
  description,
  image: [defaultImage],
  url: fullCanonicalUrl,
  mainEntityOfPage: fullCanonicalUrl,
  datePublished: pubTime,
  dateModified: modTime,
  author: { "@type": "Person", name: authorName },
  keywords: tags.join(", "),
  publisher: {
    "@type": "Organization",
    name: "Patrick’s Data Lab",
    logo: {
      "@type": "ImageObject",
      url: `${siteUrl}/favicon/favicon-96x96.png`
    }
  }
})} />

<!-- ============================================= -->
<!-- JSON-LD: BREADCRUMBS -->
<!-- ============================================= -->
{breadcrumbs.length > 0 && (
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
      {
        "@type": "ListItem",
        position: 1,
        name: "Home",
        item: siteUrl,
      },
      ...breadcrumbs
    ]
  })} />
)}

<!-- ============================================= -->
<!-- JSON-LD: GLOBAL PERSON (Sitelinks Searchbox) -->
<!-- ============================================= -->
<script type="application/ld+json" set:html={JSON.stringify(personSchema)} />

<!-- ============================================= -->
<!-- JSON-LD: ORGANIZATION -->
<!-- ============================================= -->
<script type="application/ld+json" set:html={JSON.stringify(orgSchema)} />

<!-- ============================================= -->
<!-- TECHNICAL SEO -->
<!-- ============================================= -->
<meta name="viewport" content="width=device-width, initial-scale=1.0" />