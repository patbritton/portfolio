---
import MainLayout from './MainLayout.astro';
import { getCollection } from 'astro:content';
import SearchWidget from '../components/SearchWidget.jsx';
import '../styles/blog-layout.css'; 
import SEO from '../components/SEO.astro';
import SocialShareButtons from '../components/SocialShareButtons.jsx';

const { frontmatter } = Astro.props;

// All posts
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Formatted display date
const dateStr = new Date(frontmatter.pubDate).toLocaleDateString('en-US', {
  year: 'numeric', month: 'long', day: 'numeric'
});

// Title + Description
const title = frontmatter.title;
const description = frontmatter.description;

// Canonical path (for SEO component)
const canonicalPath = `/blog/${frontmatter.slug}/`;

// Full absolute URL (for sharing)
const postUrl = Astro.url.href;

// Tags
const tags = frontmatter.tags || [];

// Publish / Update dates
const publishedTime = frontmatter.pubDate?.toISOString?.() || new Date().toISOString();
const modifiedTime = frontmatter.updatedDate?.toISOString?.() || publishedTime;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- SEO Fully Wired -->
    <SEO 
      title={title}
      description={description}
      canonicalUrl={Astro.url.href}
      image={frontmatter.image}           // optional
      siteName="Patrick's Data Lab"
      type="article"
      tags={tags}
      publishedTime={publishedTime}
      modifiedTime={modifiedTime}
    />

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Patrick's Data Lab" href="/rss.xml" />

    <!-- Favicons -->
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Patrick's Data Playground" />
    <link rel="manifest" href="/favicon/site.webmanifest" />

  </head>

  <body>
    <MainLayout title={title} description={description} canonicalUrl={canonicalPath} type="article">

      <div class="docs-grid">
        
        <article class="content-area">

          <header class="post-header">
            <span class="post-date">{dateStr}</span>
            <h1>{frontmatter.title}</h1>

            <!-- SHARE BUTTONS (below title) -->
            <div class="share-container">
              <SocialShareButtons title={title} url={postUrl} client:load />
            </div>
          </header>

          <hr class="divider" />

          <div class="prose">
            <slot />
          </div>

          <!-- TAGS AT BOTTOM -->
          {tags.length > 0 && (
            <div class="tags tags-bottom">
              {tags.map(tag => (
                <a href={`/tags/${tag}`} class="tag">#{tag}</a>
              ))}
            </div>
          )}

        </article>

        <aside class="sidebar">
          <div class="sidebar-inner">
            <SearchWidget client:load posts={allPosts} />
            <h3>Recent Updates</h3>

            <ul class="post-list">
              {sortedPosts.map(post => (
                <li>
                  <a 
                    href={`/blog/${post.slug}`} 
                    class={frontmatter.title === post.data.title ? 'active' : ''}
                  >
                    {post.data.title}
                    <span class="date-small">
                      {post.data.pubDate.toISOString().slice(0, 10)}
                    </span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </aside>

      </div>

    </MainLayout>
  </body>
</html>
